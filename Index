<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>Сказочное шоу с феями</title>
<style>
  body { margin:0; background:#050022; overflow:hidden; }
  canvas { display:block; }
  #message {
    position:absolute; top:10px; left:50%; transform:translateX(-50%);
    color:#fff; font-family:sans-serif; font-size:20px; text-align:center;
    background: rgba(0,0,0,0.5); padding:5px 10px; border-radius:5px;
  }
</style>
</head>
<body>
<div id="message">Добро пожаловать в сказочное шоу! Кликни на фею или шарик!</div>

<script src="https://cdn.jsdelivr.net/npm/three@0.155.0/build/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.155.0/examples/js/loaders/GLTFLoader.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.155.0/examples/js/controls/OrbitControls.js"></script>

<script>
// Сцена и камера
let scene = new THREE.Scene();
let camera = new THREE.PerspectiveCamera(60, window.innerWidth/window.innerHeight, 0.1, 1000);
camera.position.set(0, 1.5, 5);
let renderer = new THREE.WebGLRenderer({antialias:true});
renderer.setSize(window.innerWidth, window.innerHeight);
document.body.appendChild(renderer.domElement);

let controls = new THREE.OrbitControls(camera, renderer.domElement);
controls.enableDamping = true;
controls.enablePan = false;
controls.minDistance = 3;
controls.maxDistance = 7;

// Освещение
scene.add(new THREE.DirectionalLight(0xffffff, 1.2).position.set(5,10,5));
scene.add(new THREE.AmbientLight(0x555555));

// Частицы блёстки
let particleCount = 200;
let particles = new THREE.BufferGeometry();
let pPositions = [];
for(let i=0;i<particleCount;i++) pPositions.push(Math.random()*6-3, Math.random()*3+0.5, Math.random()*4-2);
particles.setAttribute('position', new THREE.Float32BufferAttribute(pPositions,3));
let pMaterial = new THREE.PointsMaterial({color:0xff88ff, size:0.05, transparent:true, opacity:0.7});
let particleSystem = new THREE.Points(particles,pMaterial);
scene.add(particleSystem);

// Феи
let fairies = [];
let loader = new THREE.GLTFLoader();
let fairyColors = [0x88ccff, 0xff88ff, 0x88ff88];
for(let i=0;i<3;i++){
    loader.load('https://models.readyplayer.me/3d/fairy.glb', function(gltf){
        let fairy = gltf.scene;
        fairy.scale.set(0.5,0.5,0.5);
        fairy.position.set((i-1)*1.5,1.5,0);
        fairy.color = fairyColors[i];
        fairy.traverse(child=>{
            if(child.isMesh){
                child.material.transparent = true;
                child.material.opacity = 0.8;
                child.material.emissive = new THREE.Color(fairy.color);
                child.material.emissiveIntensity = 0.6;
            }
        });
        fairy.wings = fairy.getObjectByName('wings') || fairy;
        fairy.leftEye = fairy.getObjectByName('eye_L') || fairy;
        fairy.rightEye = fairy.getObjectByName('eye_R') || fairy;
        scene.add(fairy);
        fairies.push(fairy);
    });
}

// Магические шарики
let balls = [];
let ballGeometry = new THREE.SphereGeometry(0.12,16,16);
for(let i=0;i<10;i++){
    let ball = new THREE.Mesh(ballGeometry,new THREE.MeshStandardMaterial({
        color: fairyColors[i%3],
        emissive: fairyColors[i%3],
        emissiveIntensity:0.7
    }));
    ball.position.set(Math.random()*4-2, Math.random()+1, Math.random()*2-1);
    scene.add(ball);
    balls.push(ball);
}

// Мышь/касание
let mouse = new THREE.Vector2(0,0);
window.addEventListener('mousemove', e=>{ mouse.x=(e.clientX/window.innerWidth)*2-1; mouse.y=-(e.clientY/window.innerHeight)*2+1; });
window.addEventListener('touchmove', e=>{ if(e.touches.length>0){ mouse.x=(e.touches[0].clientX/window.innerWidth)*2-1; mouse.y=-(e.touches[0].clientY/window.innerHeight)*2+1; } });

// Анимация
function animate(){
    requestAnimationFrame(animate);
    controls.update();
    let time = Date.now()*0.002;

    // Частицы
    let positions = particleSystem.geometry.attributes.position.array;
    for(let i=0;i<particleCount;i++){
        positions[i*3+1] += 0.002*Math.sin(time+i);
        if(positions[i*3+1]>4) positions[i*3+1] = 0.5;
    }
    particleSystem.geometry.attributes.position.needsUpdate = true;

    // Феи
    fairies.forEach((fairy,i)=>{
        fairy.rotation.y += 0.01;
        fairy.position.y = Math.sin(time+i)*0.2+1.5;
        fairy.rotation.z = Math.sin(time*0.5)*0.1;
        let blink = (Math.sin(time*5)+1)/2<0.1?0.1:1;
        if(fairy.leftEye) fairy.leftEye.scale.y = blink;
        if(fairy.rightEye) fairy.rightEye.scale.y = blink;
        if(fairy.wings) fairy.wings.rotation.z=Math.sin(time*10)*0.3;
        // Фея смотрит на курсор
        let vector = new THREE.Vector3(mouse.x, mouse.y, 0.5);
        vector.unproject(camera);
        let dir = vector.sub(camera.position).normalize();
        let distance = (fairy.position.z - camera.position.z)/dir.z;
        let pos = camera.position.clone().add(dir.multiplyScalar(distance));
        fairy.lookAt(pos.x, fairy.position.y, pos.z);
    });

    // Шарики
    balls.forEach((b,i)=>{ b.position.y=1+Math.sin(time+i)*0.2; b.material.emissiveIntensity=0.5+0.5*Math.sin(time*5+i); });

    renderer.render(scene,camera);
}
animate();

// Взаимодействие
window.addEventListener('click', e=>{
    let raycaster = new THREE.Raycaster();
    raycaster.setFromCamera(mouse,camera);
    let intersects = raycaster.intersectObjects([...fairies,...balls], true);
    if(intersects.length>0){
        let phrases=["Молодцы!","Фантастика!","Ура! Отлично!","Вы волшебники!"];
        speechSynthesis.speak(new SpeechSynthesisUtterance(phrases[Math.floor(Math.random()*phrases.length)]));
        let start=Date.now();
        // Танец фей
        fairies.forEach(fairy=>{
            let dance=()=>{
                let t=(Date.now()-start)/300;
                if(t<1){ fairy.position.y=1.5+Math.sin(t*Math.PI*2)*0.3; requestAnimationFrame(dance); }
            }
            dance();
        });
        // Магические объекты летят к камере
        intersects.forEach(obj=>{
            if(balls.includes(obj.object)){
                let ball=obj.object;
                let target=camera.position.clone().add(new THREE.Vector3(0,0,-1));
                let startPos=ball.position.clone();
                let move=()=>{
                    let t=(Date.now()-start)/500;
                    if(t<1){ ball.position.lerpVectors(startPos,target,t); requestAnimationFrame(move); }
                }
                move();
            }
        });
    }
});

window.addEventListener('resize', ()=>{
    camera.aspect = window.innerWidth/window.innerHeight;
    camera.updateProjectionMatrix();
    renderer.setSize(window.innerWidth, window.innerHeight);
});
</script>
</body>
</html>
